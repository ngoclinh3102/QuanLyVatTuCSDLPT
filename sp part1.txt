//ccn
USE [QLVT_DATHANG]
GO
/****** Object:  StoredProcedure [dbo].[SP_CCN]    Script Date: 12/18/2021 8:22:35 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROC [dbo].[SP_CCN]
@MANV INT
AS
DECLARE @MACN NCHAR(10) ,@HO nvarchar(40),@TEN nvarchar(10),@DIACHI nvarchar(100),@NGAYSINH DATETIME,@LUONG FLOAT,@MAMOI INT
BEGIN 
	IF EXISTS(SELECT * FROM NhanVien WHERE MANV=@MANV)
	BEGIN
	SELECT @MACN=MACN ,@HO=HO,@TEN=TEN,@DIACHI=DIACHI,@NGAYSINH=NGAYSINH,@LUONG=LUONG FROM NhanVien WHERE MANV=@MANV
	IF EXISTS(SELECT * FROM LINK1.QLVT_DATHANG.DBO.NHANVIEN WHERE MACN!=@MACN AND HO=@HO AND TEN=@TEN AND DIACHI=@DIACHI AND NGAYSINH=@NGAYSINH AND @LUONG=LUONG AND TrangThaiXoa=1)
	BEGIN
		UPDATE NHANVIEN SET TrangThaiXoa=1  WHERE MANV=@MANV
		UPDATE LINK1.QLVT_DATHANG.DBO.NHANVIEN SET TrangThaiXoa=0
	END

	ELSE
	IF @MACN='CN1'
	BEGIN

	UPDATE NhanVien SET TrangThaiXoa=1  WHERE MANV=@MANV
	SELECT @MAMOI=(SELECT MAX(MANV) FROM LINK0.QLVT_DATHANG.DBO.NHANVIEN)
	set @MAMOI=@MAMOI+1
	INSERT INTO LINK1.QLVT_DATHANG.DBO.NHANVIEN(MANV, HO, TEN, DIACHI, NGAYSINH, LUONG, MACN, TrangThaiXoa) VALUES(@MAMOI,@HO,@TEN,@DIACHI,@NGAYSINH,@LUONG,'CN2',0)
	exec Xoa_Login @MANV
	END

	IF @MACN='CN2'
	BEGIN
	UPDATE NhanVien SET TrangThaiXoa=1  WHERE MANV=@MANV
	SELECT @MAMOI=(SELECT MAX(MANV) FROM LINK0.QLVT_DATHANG.DBO.NHANVIEN)
	set @MAMOI=@MAMOI+1
	INSERT INTO LINK1.QLVT_DATHANG.DBO.NHANVIEN(MANV, HO, TEN, DIACHI, NGAYSINH, LUONG, MACN, TrangThaiXoa) VALUES(@MAMOI,@HO,@TEN,@DIACHI,@NGAYSINH,@LUONG,'CN1',0)
	exec Xoa_Login @MANV
	END
	END
END


/// check id ma vt
USE [QLVT_DATHANG]
GO
/****** Object:  StoredProcedure [dbo].[SP_CHECKID]    Script Date: 12/18/2021 8:22:39 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[SP_CHECKID]
@Code NVARCHAR(15), @Type NVARCHAR(15)
AS
BEGIN
	-- Nhân viên
	IF(@Type = 'MANV')
	BEGIN
		IF EXISTS(SELECT * FROM dbo.NhanVien WHERE dbo.NhanVien.MANV = @Code)
			RETURN 1; -- Mã NV tồn tại ở phân mảnh hiện tại
		ELSE IF EXISTS(SELECT * FROM LINK1.QLVT_DATHANG.dbo.NhanVien AS NV WHERE NV.MANV = @Code)
			RETURN 2; -- Mã NV tồn tại ở phân mảnh khác
	END

	-- Kho
	IF(@Type = 'MAKHO')
	BEGIN
		IF EXISTS(SELECT * FROM dbo.Kho WHERE dbo.Kho.MAKHO = @Code)
			RETURN 1; -- Mã kho tồn tại ở phân mảnh hiện tại
		ELSE IF EXISTS(SELECT * FROM LINK1.QLVT_DATHANG.dbo.Kho AS KHO WHERE KHO.MAKHO = @Code)
			RETURN 2; -- Mã Kho tồn tại ở phân mảnh khác
	END
	IF(@Type = 'TENKHO')
	BEGIN
		IF EXISTS(SELECT * FROM dbo.Kho WHERE dbo.Kho.TENKHO = @Code)
			RETURN 1; -- Tên kho tồn tại ở phân mảnh hiện tại
		ELSE IF EXISTS(SELECT * FROM LINK1.QLVT_DATHANG.dbo.Kho AS KHO WHERE KHO.TENKHO = @Code)
			RETURN 2; -- Tên Kho tồn tại ở phân mảnh khác
	END

	-- Đặt hàng
	IF(@Type = 'MasoDDH')
	BEGIN
		IF EXISTS(SELECT * FROM dbo.DatHang WHERE dbo.DatHang.MasoDDH = @Code)
			RETURN 1; -- Mã DDH tồn tại ở phân mảnh hiện tại
		ELSE IF EXISTS(SELECT * FROM LINK1.QLVT_DATHANG.dbo.DatHang AS DH WHERE DH.MasoDDH = @Code)
			RETURN 2; -- Mã DDH tồn tại ở phân mảnh khác
	END

	-- Phiếu Xuất
	IF(@Type = 'MAPX')
	BEGIN
		IF EXISTS(SELECT * FROM dbo.PhieuXuat WHERE dbo.PhieuXuat.MAPX = @Code)
			RETURN 1; -- Mã PX tồn tại ở phân mảnh hiện tại
		ELSE IF EXISTS(SELECT * FROM LINK1.QLVT_DATHANG.dbo.PhieuXuat AS PX WHERE PX.MAPX = @Code)
			RETURN 2; -- Mã PX tồn tại ở phân mảnh khác
	END

	-- Phiếu Nhập
	IF(@Type = 'MAPN')
	BEGIN
		IF EXISTS(SELECT * FROM dbo.PhieuNhap WHERE dbo.PhieuNhap.MAPN = @Code)
			RETURN 1; -- Mã PN tồn tại ở phân mảnh hiện tại
		ELSE IF EXISTS(SELECT * FROM LINK1.QLVT_DATHANG.dbo.PhieuNhap AS PN WHERE PN.MAPN = @Code)
			RETURN 2; -- Mã PN tồn tại ở phân mảnh khác
	END

	-- Vật tư, chỉ cần check ở site hiện tại
	IF(@Type = 'MAVT')
	BEGIN
		IF EXISTS(SELECT * FROM dbo.Vattu WHERE MAVT = @Code)
		RETURN 1;
	END

	RETURN 0 -- Không bị trùng
END



//id tra cuu


USE [QLVT_DATHANG]
GO
/****** Object:  StoredProcedure [dbo].[SP_CHECKID_TRACUU]    Script Date: 12/18/2021 8:22:42 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[SP_CHECKID_TRACUU]
@Code NVARCHAR(30), @Type NVARCHAR(15)
AS
BEGIN
	-- Nhân viên
	IF(@Type = 'MANV')
	BEGIN
		IF EXISTS(SELECT * FROM LINK2.QLVT_DATHANG.dbo.NhanVien AS NV WHERE NV.MANV = @Code)
			RETURN 1; -- Mã NV tồn tại đã tồn tại
	END

	-- Kho
	IF(@Type = 'MAKHO')
	BEGIN
		IF EXISTS(SELECT * FROM LINK2.QLVT_DATHANG.dbo.Kho AS KHO WHERE KHO.MAKHO = @Code)
			RETURN 1; -- Mã Kho đã tồn tại
	END

	IF(@Type = 'TENKHO')
	BEGIN
		IF EXISTS(SELECT * FROM LINK2.QLVT_DATHANG.dbo.Kho AS KHO WHERE KHO.TENKHO = @Code)
			RETURN 1; -- Tên Kho đã tồn tại
	END

	RETURN 0 -- Không bị trùng
END
//DN
USE [QLVT_DATHANG]
GO
/****** Object:  StoredProcedure [dbo].[SP_DANGNHAP]    Script Date: 12/18/2021 8:23:40 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROC [dbo].[SP_DANGNHAP]
@TENLOGIN NVARCHAR (50)
AS
DECLARE @TENUSER NVARCHAR(50)
SELECT @TENUSER=NAME FROM sys.sysusers WHERE sid = SUSER_SID(@TENLOGIN)
 
 SELECT USERNAME = @TENUSER, 
  HOTEN = (SELECT HO+ ' '+ TEN FROM NHANVIEN  WHERE MANV = @TENUSER ),
   TENNHOM= NAME
   FROM sys.sysusers 
   WHERE UID = (SELECT GROUPUID 
                 FROM SYS.SYSMEMBERS 
                   WHERE MEMBERUID= (SELECT UID FROM sys.sysusers 
                                      WHERE NAME=@TENUSER))



//rp
USE [QLVT_DATHANG]
GO
/****** Object:  StoredProcedure [dbo].[SP_REPORTDonhangkhongcoPhieuNhap]    Script Date: 12/18/2021 8:23:54 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROC [dbo].[SP_REPORTDonhangkhongcoPhieuNhap]
AS
begin
SELECT DH.MasoDDH,Ngay,NhaCC,TenNV, TENVT, SOLUONG, DONGIA 
FROM
	(SELECT MasoDDH,Ngay,NhaCC, MANV FROM dbo.DatHang
	WHERE DatHang.MasoDDH not in (
	SELECT MasoDDH FROM dbo.PhieuNhap)) DH,
	(SELECT MANV,TENNV = HO +' ' +Ten FROM dbo.NhanVien) NV,
	(SELECT MAVT,TENVT FROM dbo.Vattu) VT,
	CTDDH CT
WHERE (NV.MANV = DH.MANV) AND (VT.MAVT =CT.MAVT) AND (CT.MasoDDH = DH.MasoDDH)
end

//rp

USE [QLVT_DATHANG]
GO
/****** Object:  StoredProcedure [dbo].[SP_RP_DSVATTU]    Script Date: 12/18/2021 8:24:08 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[SP_RP_DSVATTU] AS
begin
SELECT * FROM dbo.Vattu WITH (INDEX=IX_TENVT)
end
//rp


USE [QLVT_DATHANG]
GO
/****** Object:  StoredProcedure [dbo].[SP_RP_TTNhanVien]    Script Date: 12/18/2021 8:24:23 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROC  [dbo].[SP_RP_TTNhanVien]
as
BEGIN

	BEGIN
	SELECT MANV, HO + ' ' + TEN AS HOTEN, DIACHI, NGAYSINH, LUONG
	FROM dbo.NhanVien  WITH(INDEX=IX_TrangThaiXoa)
	WHERE TrangThaiXoa=0  order by TEN,HO
	END

END


//rp
USE [QLVT_DATHANG]
GO
/****** Object:  StoredProcedure [dbo].[SP_RPTonghopNhapXuat]    Script Date: 12/18/2021 8:24:48 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROC [dbo].[SP_RPTonghopNhapXuat]
	@NGAYBD date, @NGAYKT date
AS
BEGIN
	SET NOCOUNT ON;
		IF 1=0 BEGIN
			SET FMTONLY OFF
		END
		SELECT	PN.NGAY,
				NHAP = SUM(CTPN.SOLUONG * CTPN.DONGIA), 
				TYLENHAP = (SUM(CTPN.SOLUONG * CTPN.DONGIA) / (SELECT SUM(SOLUONG*DONGIA) FROM CTPN INNER JOIN PhieuNhap WITH (INDEX = IX_NGAY) ON CTPN.MAPN=PhieuNhap.MAPN WHERE NGAY BETWEEN @NGAYBD AND @NGAYKT)) INTO #PhieuNhapTemp
		FROM PhieuNhap AS PN
			INNER JOIN (SELECT * FROM CTPN) AS CTPN 
			ON PN.MAPN = CTPN.MAPN
		WHERE NGAY BETWEEN @NGAYBD AND @NGAYKT
		GROUP BY PN.NGAY

		SELECT	PX.NGAY,
				XUAT = SUM(CTPX.SOLUONG * CTPX.DONGIA),
				TYLEXUAT = (SUM(CTPX.SOLUONG * CTPX.DONGIA) / (SELECT SUM(SOLUONG*DONGIA) FROM CTPX INNER JOIN PhieuXuat WITH (INDEX = IX_NGAYPX) ON CTPX.MAPX=PhieuXuat.MAPX WHERE NGAY BETWEEN @NGAYBD AND @NGAYKT))  INTO #PhieuXuatTemp
		FROM PhieuXuat AS PX
			INNER JOIN (SELECT * FROM CTPX) AS CTPX 
			ON PX.MAPX = CTPX.MAPX
		WHERE NGAY BETWEEN @NGAYBD AND @NGAYKT
		GROUP BY PX.NGAY				

		SELECT 
		ISNULL(PN.NGAY, PX.NGAY) AS NGAY, --
		ISNULL(PN.NHAP, 0) AS NHAP,
		ISNULL(PN.TYLENHAP, 0) AS TYLENHAP,
		ISNULL(PX.XUAT, 0) AS XUAT,
		ISNULL(PX.TYLEXUAT, 0) AS TYLEXUAT
		FROM #PhieuNhapTemp AS PN
		FULL JOIN #PhieuXuatTemp AS PX
		ON PN.NGAY = PX.NGAY
		ORDER BY NGAY
END


//sp

USE [QLVT_DATHANG]
GO
/****** Object:  StoredProcedure [dbo].[sp_TaoTaiKhoan]    Script Date: 12/18/2021 8:25:11 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROC [dbo].[sp_TaoTaiKhoan]
	@LGNAME VARCHAR(50),
	@PASS VARCHAR(50),
	@USERNAME VARCHAR(50),
	@ROLE VARCHAR(50)
AS
BEGIN
  DECLARE @RET INT
  EXEC @RET= SP_ADDLOGIN @LGNAME, @PASS,'QLVT_DATHANG'                     

  IF (@RET =1)  -- LOGIN NAME BI TRUNG
     RETURN 1

  EXEC @RET= SP_GRANTDBACCESS @LGNAME, @USERNAME
  IF (@RET =1)  -- USER  NAME BI TRUNG
  BEGIN
       EXEC SP_DROPLOGIN @LGNAME
       RETURN 2
  END
  EXEC sp_addrolemember @ROLE, @USERNAME

  IF @ROLE= 'CONGTY' 
	BEGIN
		EXEC sp_addsrvrolemember @LGNAME, 'sysadmin'
		EXEC sp_addsrvrolemember @LGNAME, 'SecurityAdmin'
		EXEC sp_addsrvrolemember @LGNAME, 'ProcessAdmin'
	END

  IF @ROLE= 'CHINHANH'
	BEGIN 
		EXEC sp_addsrvrolemember @LGNAME, 'sysadmin'
		EXEC sp_addsrvrolemember @LGNAME, 'SecurityAdmin'
		EXEC sp_addsrvrolemember @LGNAME, 'ProcessAdmin'
	END
  IF @ROLE= 'USER'
	BEGIN  
		EXEC sp_addsrvrolemember @LGNAME, 'ProcessAdmin'
	END

END

//rp


USE [QLVT_DATHANG]
GO
/****** Object:  StoredProcedure [dbo].[sp_TIM_MANV]    Script Date: 12/18/2021 8:25:21 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROC [dbo].[sp_TIM_MANV]
@MANV INT
AS
 IF EXISTS (SELECT MANV FROM NHANVIEN WHERE MANV=@MANV )
 RETURN 1;
 IF EXISTS (SELECT MANV FROM LINK2.QLVT_DATHANG.DBO.NHANVIEN WHERE MANV=@MANV )
 RETURN 1;
 ELSE
 RETURN 0;

//

USE [QLVT_DATHANG]
GO
/****** Object:  StoredProcedure [dbo].[SP_TRANV]    Script Date: 12/18/2021 8:25:33 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROC [dbo].[SP_TRANV]
@MANV INT
AS
DECLARE @MACN NCHAR(10) ,@HO nvarchar(40),@TEN nvarchar(10),@DIACHI nvarchar(100),@NGAYSINH DATETIME,@LUONG FLOAT
BEGIN
UPDATE NhanVien SET TrangThaiXoa=0 WHERE MANV=@MANV
SELECT @MACN=MACN ,@HO=HO,@TEN=TEN,@DIACHI=DIACHI,@NGAYSINH=NGAYSINH,@LUONG=LUONG FROM NhanVien WHERE MANV=@MANV
IF EXISTS(SELECT * FROM LINK1.QLVT_DATHANG.DBO.NHANVIEN WHERE MACN!=@MACN AND HO=@HO AND TEN=@TEN AND DIACHI=@DIACHI AND NGAYSINH=@NGAYSINH AND @LUONG=LUONG AND TrangThaiXoa=0 )
BEGIN
UPDATE LINK1.QLVT_DATHANG.DBO.NHANVIEN SET TrangThaiXoa=1 WHERE  MACN!=@MACN AND HO=@HO AND TEN=@TEN AND DIACHI=@DIACHI AND NGAYSINH=@NGAYSINH AND @LUONG=LUONG AND TrangThaiXoa=0
END
END


//sp
USE [QLVT_DATHANG]
GO
/****** Object:  StoredProcedure [dbo].[SP_TTNHANVIEN]    Script Date: 12/18/2021 8:25:47 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROC [dbo].[SP_TTNHANVIEN]
@MANV INT
AS
BEGIN
	SELECT MANV,HO+TEN as HOTEN,DIACHI,NGAYSINH,LUONG,MACN FROM NhanVien WHERE MANV=@MANV
END

//sp

USE [QLVT_DATHANG]
GO
/****** Object:  StoredProcedure [dbo].[SP_UpdateSLVatTu]    Script Date: 12/18/2021 8:26:00 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[SP_UpdateSLVatTu]
@MAVT nchar(4),
@SOLUONG int,
@TYPE NVARCHAR(15)
AS
BEGIN
	IF(@TYPE = 'IMPORT')
	BEGIN
		IF EXISTS(SELECT MAVT FROM dbo.CTPN WHERE dbo.CTPN.MAVT =  @MAVT)
			BEGIN
				UPDATE dbo.Vattu SET SOLUONGTON = SOLUONGTON + @SOLUONG WHERE MAVT= @MAVT
				RETURN 1
			END
			ELSE
				RETURN 0
	END

	IF(@TYPE = 'EXPORT')
	BEGIN
		IF EXISTS(SELECT MAVT FROM dbo.CTPX WHERE dbo.CTPX.MAVT =  @MAVT)
			BEGIN
				UPDATE dbo.Vattu SET SOLUONGTON = SOLUONGTON - @SOLUONG WHERE MAVT= @MAVT
				RETURN 1
			END
			ELSE
				RETURN 0
	END
END

//sp
USE [QLVT_DATHANG]
GO
/****** Object:  StoredProcedure [dbo].[V_DSNV_CHUATK]    Script Date: 12/18/2021 8:26:08 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER proc [dbo].[V_DSNV_CHUATK]
as
BEGIN

SELECT MANV,HO+' '+TEN as HOTEN
FROM NHANVIEN 
WHERE TrangThaiXoa = 0 AND NOT EXISTS(SELECT SUSER_SNAME(sid) FROM sys.sysusers WHERE name = CAST(MANV AS NVARCHAR))
END
//sp

USE [QLVT_DATHANG]
GO
/****** Object:  StoredProcedure [dbo].[V_DSNV_TK]    Script Date: 12/18/2021 8:26:16 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER proc [dbo].[V_DSNV_TK]
as
BEGIN

SELECT MANV,HO+' '+TEN as HOTEN
FROM NHANVIEN 
WHERE TrangThaiXoa = 0 AND  EXISTS(SELECT SUSER_SNAME(sid) FROM sys.sysusers WHERE name = CAST(MANV AS NVARCHAR))
END
//sp

USE [QLVT_DATHANG]
GO
/****** Object:  StoredProcedure [dbo].[Xoa_Login]    Script Date: 12/18/2021 8:26:24 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROC [dbo].[Xoa_Login]
@USRNAME VARCHAR(50)
AS
DECLARE @LGNAME VARCHAR(50)
IF EXISTS (SELECT SUSER_SNAME(sid) FROM sys.sysusers WHERE name = CAST(@USRNAME AS NVARCHAR))
BEGIN
	SET @LGNAME = CAST((SELECT SUSER_SNAME(sid) FROM sys.sysusers WHERE name = CAST(@USRNAME AS NVARCHAR)) AS VARCHAR(50))
	EXEC SP_DROPUSER @USRNAME
	EXEC SP_DROPLOGIN @LGNAME
	 RETURN 1;
END
ELSE
BEGIN
 RETURN 0;
END







//DSNV_TK

USE [QLVT_DATHANG]
GO
/****** Object:  StoredProcedure [dbo].[V_DSNV_TK]    Script Date: 12/14/2021 3:23:14 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER proc [dbo].[V_DSNV_TK]
as
BEGIN

SELECT MANV,HO+' '+TEN as HOTEN
FROM NHANVIEN 
WHERE TrangThaiXoa = 0 AND  EXISTS(SELECT SUSER_SNAME(sid) FROM sys.sysusers WHERE name = CAST(MANV AS NVARCHAR))
END

// ds nhan vien chua co tk

USE [QLVT_DATHANG]
GO
/****** Object:  StoredProcedure [dbo].[V_DSNV_CHUATK]    Script Date: 12/14/2021 7:51:14 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER proc [dbo].[V_DSNV_CHUATK]
as
BEGIN

SELECT MANV,HO+' '+TEN as HOTEN
FROM NHANVIEN 
WHERE TrangThaiXoa = 0 AND NOT EXISTS(SELECT SUSER_SNAME(sid) FROM sys.sysusers WHERE name = CAST(MANV AS NVARCHAR))
END




//rp tt nhan vien


USE [QLVT_DATHANG]
GO
/****** Object:  StoredProcedure [dbo].[SP_RP_TTNhanVien]    Script Date: 12/14/2021 7:52:09 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROC  [dbo].[SP_RP_TTNhanVien]
as
BEGIN

	BEGIN
	SELECT MANV, HO + ' ' + TEN AS HOTEN, DIACHI, NGAYSINH, LUONG
	FROM dbo.NhanVien  WITH(INDEX=IX_TrangThaiXoa)
	WHERE TrangThaiXoa=0  order by TEN,HO
	END

END

// chi tiet sl nhap xuat


USE [QLVT_DATHANG]
GO
/****** Object:  StoredProcedure [dbo].[SP_RPChiTietSL_TriGiaNhapXuat]    Script Date: 12/14/2021 7:52:41 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROC [dbo].[SP_RPChiTietSL_TriGiaNhapXuat]
@ROLE NCHAR(10),@LOAI NCHAR(4) ,@DATEBEGIN DATE, @DATEEND DATE
AS
BEGIN
IF(@ROLE='CONGTY')
	BEGIN
		IF(@LOAI='NHAP')
		BEGIN
			select PhieuNhap.NGAY,Vattu.TENVT,CTPN.SOLUONG,TRIGIA=CTPN.DONGIA*CTPN.SOLUONG
			from ((CTPN INNER JOIN PhieuNhap WITH(INDEX=IX_NGAY) ON CTPN.MAPN=PhieuNhap.MAPN)INNER JOIN Vattu ON CTPN.MAVT=Vattu.MAVT) 
			WHERE NGAY BETWEEN @DATEBEGIN AND @DATEEND
			union
			select PhieuNhap.NGAY,Vattu.TENVT,CTPN.SOLUONG,TRIGIA=CTPN.DONGIA*CTPN.SOLUONG
			from ((LINK1.QLVT_DATHANG.DBO.CTPN INNER JOIN LINK1.QLVT_DATHANG.DBO.PhieuNhap  ON CTPN.MAPN=PhieuNhap.MAPN)INNER JOIN LINK1.QLVT_DATHANG.DBO.Vattu ON CTPN.MAVT=Vattu.MAVT)
			WHERE NGAY BETWEEN @DATEBEGIN AND @DATEEND
		END
		ELSE
		BEGIN
			select PhieuXuat.NGAY,Vattu.TENVT,CTPX.SOLUONG,TRIGIA=CTPX.DONGIA*CTPX.SOLUONG
			from ((CTPX INNER JOIN PhieuXuat WITH(INDEX=IX_NGAYPX) ON CTPX.MAPX=PhieuXuat.MAPX)INNER JOIN Vattu ON CTPX.MAVT=Vattu.MAVT)
			WHERE NGAY BETWEEN @DATEBEGIN AND @DATEEND
			union
			select PhieuXuat.NGAY,Vattu.TENVT,CTPX.SOLUONG,TRIGIA=CTPX.DONGIA*CTPX.SOLUONG
			from ((LINK1.QLVT_DATHANG.DBO.CTPX INNER JOIN LINK1.QLVT_DATHANG.DBO.PhieuXuat  ON CTPX.MAPX=PhieuXuat.MAPX)INNER JOIN LINK1.QLVT_DATHANG.DBO.Vattu ON CTPX.MAVT=Vattu.MAVT)
			WHERE NGAY BETWEEN @DATEBEGIN AND @DATEEND
		END
	END
	ELSE
	BEGIN
		IF(@LOAI='NHAP')
		BEGIN
			select PhieuNhap.NGAY,Vattu.TENVT,CTPN.SOLUONG,TRIGIA=CTPN.DONGIA*CTPN.SOLUONG
			from ((CTPN INNER JOIN PhieuNhap WITH(INDEX=IX_NGAY)  ON CTPN.MAPN=PhieuNhap.MAPN)INNER JOIN Vattu ON CTPN.MAVT=Vattu.MAVT)
			WHERE NGAY BETWEEN @DATEBEGIN AND @DATEEND
			
		END
		ELSE
		BEGIN
			select PhieuXuat.NGAY,Vattu.TENVT,CTPX.SOLUONG,TRIGIA=CTPX.DONGIA*CTPX.SOLUONG
			from ((CTPX INNER JOIN PhieuXuat WITH(INDEX=IX_NGAYPX) ON CTPX.MAPX=PhieuXuat.MAPX)INNER JOIN Vattu ON CTPX.MAVT=Vattu.MAVT)
			WHERE NGAY BETWEEN @DATEBEGIN AND @DATEEND			
		END
	END
END


//hd nhan vien


USE [QLVT_DATHANG]
GO
/****** Object:  StoredProcedure [dbo].[SP_RPHoatDongNV]    Script Date: 12/14/2021 7:53:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROC [dbo].[SP_RPHoatDongNV] 
@MANV INT,@TIMEFROM DATE,@TIMETO DATE,@LOAI NCHAR(4)
AS
BEGIN
	IF(@LOAI='NHAP')
	BEGIN
	SELECT FORMAT(NGAY,'MMMM yyyy') as THOIGIAN,CTPN.MAPN as MAPHIEU,TENVT,TENKHO,SOLUONG,DONGIA,TRIGIA=DONGIA*SOLUONG
	FROM (((CTPN INNER JOIN Vattu ON CTPN.MAVT=Vattu.MAVT)
				 INNER JOIN PhieuNhap WITH(INDEX=IX_NGAY) ON CTPN.MAPN=PhieuNhap.MAPN)
				 INNER JOIN KHO ON KHO.MAKHO=PhieuNhap.MAKHO) WHERE NGAY BETWEEN @TIMEFROM AND @TIMETO AND PhieuNhap.MANV=@MANV
	END
	ELSE
	BEGIN
	SELECT FORMAT(NGAY,'MMMM yyyy') as THOIGIAN,CTPX.MAPX as MAPHIEU,TENVT,TENKHO,SOLUONG,DONGIA,TRIGIA=DONGIA*SOLUONG
	FROM (((CTPX INNER JOIN Vattu ON CTPX.MAVT=Vattu.MAVT)
				 INNER JOIN PhieuXuat  WITH(INDEX=IX_NGAYPX) ON CTPX.MAPX=PhieuXuat.MAPX)
				 INNER JOIN KHO ON KHO.MAKHO=PhieuXuat.MAKHO) WHERE NGAY BETWEEN @TIMEFROM AND @TIMETO AND PhieuXuat.MANV=@MANV
	END
END